import{_ as e,c as t,o as s,a as o}from"./app.7a6694fd.js";const f=JSON.parse('{"title":"Hooks","description":"","frontmatter":{},"headers":[{"level":2,"title":"Why?","slug":"why","link":"#why","children":[]},{"level":2,"title":"Hooks","slug":"hooks-1","link":"#hooks-1","children":[]},{"level":2,"title":"Events","slug":"events","link":"#events","children":[]},{"level":2,"title":"Request Lifecycle","slug":"request-lifecycle","link":"#request-lifecycle","children":[{"level":3,"title":"Definitions","slug":"definitions","link":"#definitions","children":[]},{"level":3,"title":"Request Lifecycle","slug":"request-lifecycle-1","link":"#request-lifecycle-1","children":[]},{"level":3,"title":"Full Hooks/Events Table","slug":"full-hooks-events-table","link":"#full-hooks-events-table","children":[]}]},{"level":2,"title":"Parameters","slug":"parameters","link":"#parameters","children":[{"level":3,"title":"Common Parameters","slug":"common-parameters","link":"#common-parameters","children":[]}]},{"level":2,"title":"Special Parameters","slug":"special-parameters","link":"#special-parameters","children":[]}],"relativePath":"advanced/hooks/index.md","lastUpdated":1671908681000}'),a={name:"advanced/hooks/index.md"},n=o(`<h1 id="hooks" tabindex="-1">Hooks <a class="header-anchor" href="#hooks" aria-hidden="true">#</a></h1><h2 id="why" tabindex="-1">Why? <a class="header-anchor" href="#why" aria-hidden="true">#</a></h2><p>In the real world, everybody needs more than saving and listing records. Everybody needs more complicated logic in their code. <strong>Axe API</strong> provides you a basic structure of an API. It provides you basic CRUD actions with dynamic query options. But when you need custom logic, you will not be alone. <strong>Axe API</strong> provides you <em>escape points</em> to extend your HTTP requests and manipulate them.</p><p>There are two different ways to add your business logic; <strong>Hooks</strong> and <strong>Events</strong>. They are almost the same except one differences. We are going to explain it later. But first, we should understand what the <strong>hook</strong> is.</p><h2 id="hooks-1" tabindex="-1">Hooks <a class="header-anchor" href="#hooks-1" aria-hidden="true">#</a></h2><p>Axe API automatically handles your API. It creates routes, handles HTTP requests, performs the request, and creates a response. But it doesn&#39;t just do these. It also has some escape points. With those, you can add your code to the HTTP Request-Response cycle.</p><p>For example, let&#39;s assume that you want to hash the user&#39;s password in user creation. How can we do this? First, we should create a file that is called <code>UserHooks.ts</code> under <code>app/Hooks</code>.</p><p><code>UserHooks.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> bcrypt </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">bcrypt</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">IHookParameter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">axe-api</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> onBeforeInsert </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">formData</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">IHookParameter</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// Genering salt</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">formData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">password_salt</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">bcrypt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">genSaltSync</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">10</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// Hashing the password</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">formData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">password</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">bcrypt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">hashSync</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">formData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">password</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">formData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">password_salt</span></span>
<span class="line"><span style="color:#F07178;">  )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">onBeforeInsert</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>In the code above, we used <a href="https://www.npmjs.com/package/bcrypt" target="_blank" rel="noreferrer">bcrypt</a> library to hash the user&#39;s password. By accessing form data, hashing the user&#39;s password is easy.</p><p><strong>But can this function be executed? Yes!</strong> In the booting process, Axe API tries to discover what kind of hooks and events have been written. For a model called <code>User</code>, if you create a hook which is called <code>UserHook</code>, Axe API accepts that <code>UserHooks</code> is the hook definition file for the model <code>User</code>. In the HTTP request processing time, if there is any hook that has been written, Axe API calls that hook.</p><p>This feature gives us very important flexibility. First of all, you can add any logic by the parameters which Axe API passed. Secondly, the hook functions are almost isolated. It means that writing unit tests about them is very easy.</p><p>This structure is almost the same for Events, too.</p><h2 id="events" tabindex="-1">Events <a class="header-anchor" href="#events" aria-hidden="true">#</a></h2><p>The main difference between <strong>Hooks</strong> and <strong>Events</strong> is; events are <strong>asynchronous</strong>. It means that if you are using an <strong>hooks</strong> and handle the request, the HTTP request cycle waits for you to do your task. But in events, when you handle the event, the HTTP requests cycle keeps working and returns a response. So, if you want to send an e-mail to the user, you should use <strong>Events</strong>. On the other hand, if you want to be involved in the query or any business logic in the HTTP request cycle, you should use <strong>Hooks</strong>.</p><p>Using <strong>Events</strong> is very easy, almost same with the hooks. There is only one different thing in usage. Which is creating the event file under the <code>app/Events</code> folders.</p><p><code>app/Events/UserEvents.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">IHookParameter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">axe-api</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> onAfterInsert </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">formData</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">IHookParameter</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// You can send an email to the user in here...</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">onAfterInsert</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><h2 id="request-lifecycle" tabindex="-1">Request Lifecycle <a class="header-anchor" href="#request-lifecycle" aria-hidden="true">#</a></h2><p>To write hook or event functions, you should understand the Axe API HTTP Request&#39;s lifecycles. Before doing that, we are going to define basic facts.</p><h3 id="definitions" tabindex="-1">Definitions <a class="header-anchor" href="#definitions" aria-hidden="true">#</a></h3><ul><li>Handlers are types of model processing. There are five basic handlers in Axe API <ul><li>INSERT</li><li>PAGINATE</li><li>SHOW</li><li>UPDATE</li><li>DELETE</li></ul></li><li>Two different <strong>actions</strong> can be done on the data, in a handler; <ul><li>Manipulating</li><li>Fetching</li></ul></li><li>Some of handlers do only one <strong>action</strong>, but some of them do both. <ul><li>Insert: Manipulating</li><li>Update: Fetching, Manipulating</li><li>Delete: Fetching, Manipulating</li><li>Show: Fetching</li><li>Paginate: Fetching</li></ul></li></ul><p>We can show which handler do what actions in a table;</p><table><thead><tr><th>Handler</th><th>Manipulating</th><th>Fetching</th></tr></thead><tbody><tr><td>INSERT</td><td>✓</td><td></td></tr><tr><td>PAGINATE</td><td></td><td>✓</td></tr><tr><td>SHOW</td><td></td><td>✓</td></tr><tr><td>UPDATE</td><td>✓</td><td>✓</td></tr><tr><td>DELETE</td><td>✓</td><td>✓</td></tr></tbody></table><p>These values are important because we are using that definitions in <em>Request Lifecycle</em>.</p><h3 id="request-lifecycle-1" tabindex="-1">Request Lifecycle <a class="header-anchor" href="#request-lifecycle-1" aria-hidden="true">#</a></h3><p>In Axe API, we use <strong>Before</strong> and <strong>After</strong> hooks/events to give more flexibility. Also, Axe API calls hooks first. After hooks, it calls events if there any. With this information, we can describe general schema of <em>Request Lifecycle</em>;</p><ul><li>Axe API start to process HTTP Request</li><li>Call model-based middlewares</li><li>Call the handler (INSERT, UPDATE, etc.)</li><li>Call <strong>Before Fetching</strong> hooks</li><li>Call <strong>Before Fetching</strong> events</li><li>Execute <strong>Fetching</strong> action.</li><li>Call <strong>After Fetching</strong> hooks</li><li>Call <strong>After Fetching</strong> events</li><li>Call <strong>Before Manipulating</strong> hooks</li><li>Call <strong>Before Manipulating</strong> events</li><li>Execute <strong>Manipulating</strong> action.</li><li>Call <strong>After Manipulating</strong> hooks</li><li>Call <strong>After Manipulating</strong> events</li><li>Send the response.</li></ul><p>This is the basic standard of our calling Hooks/Events system. By the type of handler, you can add many different hooks/events.</p><h3 id="full-hooks-events-table" tabindex="-1">Full Hooks/Events Table <a class="header-anchor" href="#full-hooks-events-table" aria-hidden="true">#</a></h3><p>The following table describes all possible hooks by handler types.</p><table><thead><tr><th>Handler</th><th>Manipulating</th><th>Fetching</th></tr></thead><tbody><tr><td>INSERT</td><td><code>onBeforeInsert</code> <code>onAfterInsert</code></td><td></td></tr><tr><td>PAGINAT</td><td></td><td><code>onBeforePaginate</code> <code>onAfterPaginate</code></td></tr><tr><td>ALL</td><td></td><td><code>onBeforeAll</code> <code>onAfterAll</code></td></tr><tr><td>SHOW</td><td></td><td><code>onBeforeShow</code> <code>onAfterShow</code></td></tr><tr><td>UPDATE</td><td><code>onBeforeUpdate</code> <code>onAfterUpdate</code></td><td><code>onBeforeUpdateQuery</code> <code>onAfterUpdateQuery</code></td></tr><tr><td>PATCH</td><td><code>onBeforeUpdate</code> <code>onAfterUpdate</code></td><td><code>onBeforeUpdateQuery</code> <code>onAfterUpdateQuery</code></td></tr><tr><td>DELETE</td><td><code>onBeforeDelete</code> <code>onAfterDelete</code></td><td><code>onBeforeDeleteQuery</code> <code>onAfterUpdateQuery</code></td></tr></tbody></table><h2 id="parameters" tabindex="-1">Parameters <a class="header-anchor" href="#parameters" aria-hidden="true">#</a></h2><p>There are some parameters which you can use in a hook or event function.</p><h3 id="common-parameters" tabindex="-1">Common Parameters <a class="header-anchor" href="#common-parameters" aria-hidden="true">#</a></h3><ul><li><code>request</code>: Request object of <a href="https://expressjs.com/en/4x/api.html#req" target="_blank" rel="noreferrer">Expresss</a></li><li><code>response</code>: Response object of <a href="https://expressjs.com/en/4x/api.html#res" target="_blank" rel="noreferrer">Expresss</a></li><li><code>model</code>: Current model instance. For example; <code>User.ts</code>.</li><li><code>database</code>: Database connection instance. For example <a href="http://knexjs.org/#Installation-client" target="_blank" rel="noreferrer">Knex.js</a></li><li><code>relation</code>: The relation definition if the route is a related route (For example <code>api/users/:userId/posts</code>).</li><li><code>parentModel</code>: The parent model instance if the route is a related route (For example <code>api/users/:userId/posts</code>).</li></ul><h2 id="special-parameters" tabindex="-1">Special Parameters <a class="header-anchor" href="#special-parameters" aria-hidden="true">#</a></h2><ul><li><code>query</code>: The Knex.js&#39; <a href="http://knexjs.org/#Builder-wheres" target="_blank" rel="noreferrer">query instance</a>.</li><li><code>conditions</code>: The conditions which has been send by the HTTP client to filter data.</li><li><code>item</code>: The current record. (For example; the item that will be updated.)</li><li><code>result</code>: The query result. (For example SHOW and PAGINATE handlers.)</li><li><code>formData</code>: The data has been sent by HTTP client to create or update row.</li></ul><p>We can show all special parameters in the following table;</p><table><thead><tr><th>Hook/Events Name</th><th>Parameters</th></tr></thead><tbody><tr><td>onBeforeInsert</td><td>formData</td></tr><tr><td>onBeforeUpdateQuery</td><td>query</td></tr><tr><td>onBeforeUpdate</td><td>item, formData, query,</td></tr><tr><td>onBeforeDeleteQuery</td><td>query</td></tr><tr><td>onBeforeDelete</td><td>query</td></tr><tr><td>onBeforePaginate</td><td>conditions, query</td></tr><tr><td>onBeforeAll</td><td>conditions, query</td></tr><tr><td>onBeforeShow</td><td>conditions, query</td></tr><tr><td>onAfterInsert</td><td>formData, item</td></tr><tr><td>onAfterUpdateQuery</td><td>item, query</td></tr><tr><td>onAfterUpdate</td><td>item, formData, query</td></tr><tr><td>onAfterDeleteQuery</td><td>query, item</td></tr><tr><td>onAfterDelete</td><td>item</td></tr><tr><td>onAfterPaginate</td><td>results, conditions, query</td></tr><tr><td>onAfterAll</td><td>results, conditions, query</td></tr><tr><td>onAfterShow</td><td>item, conditions, query</td></tr></tbody></table>`,40),l=[n];function r(i,p,c,d,h,y){return s(),t("div",null,l)}const D=e(a,[["render",r]]);export{f as __pageData,D as default};
